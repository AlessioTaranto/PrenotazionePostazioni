@{

    ViewData["Title"] = "Rumorosità";

}

@using System.Net
@using prenotazione_postazioni_libs.Models;
@using prenotazione_postazioni_libs.Dto;
@using prenotazione_postazioni_mvc.HttpServices;
@using Newtonsoft.Json;
@inject UserHttpService _userHttpService;
@inject VoteHttpService _voteHttpService;


<style>
    .icon-img {
        width: 40%;
    }
</style>

<div class="vote_container">
    <div class="vote_list">
        @{
            User? LoggedUser = new User(
            "Andrea",
            "Redegalli",
            "redegalli03@gmail.com",
            1
            );
            


            Task<HttpResponseMessage> getAllUtentiResult = _userHttpService.GetAll();
            Task<HttpResponseMessage> getAllVotiResult = _voteHttpService.GetUserVotes(LoggedUser.Id);
            getAllUtentiResult.Wait();
            getAllVotiResult.Wait();
            List<User>? utenti = null;
            List<Vote>? voti = null;

            if (getAllUtentiResult != null && getAllUtentiResult.Result.StatusCode == HttpStatusCode.OK && getAllVotiResult.Result.StatusCode == HttpStatusCode.OK)
            {
                utenti = await getAllUtentiResult.Result.Content.ReadFromJsonAsync<List<User>?>();
                voti = await getAllVotiResult.Result.Content.ReadFromJsonAsync<List<Vote>?>();

                for (int i = 0; i < utenti.Count; i++)
                {
                    if (utenti[i].Id != LoggedUser.Id)
                    {
                        string fullName = utenti[i].Name + " " + utenti[i].Surname;
                        string rumorosita = "rumorosita" + (i + 1);
                        string rumoroso = "rumoroso" + (i + 1);
                        string non_rumoroso = "non_rumoroso" + (i + 1);
                        float? Vote = 0;

                        for (int j = 0; j < voti.Count; j++)
                        {
                            if (voti[j].IdVictim == utenti[i].Id)
                            {
                                Vote = voti[j].VoteResults;

                                <div class="vote_row">
                                    <div class="vote_row_header">
                                        <img src="img/user_icon.png" alt="user_icon">
                                        @{
                                            if (Vote >= 0.3)
                                            {
                                                <div class="status_good"></div>
                                            }
                                            if (Vote >= 0.6)
                                            {
                                                <div class="status_medium"></div>
                                            }
                                            else
                                            {
                                                <div class="status_bad"></div>
                                            }
                                        }

                                        <div class="vote_row_name">@fullName</div>
                                    </div>
                                    <div class="vote_checkboxes">
                                        <div class="vote_checkbox_item">
                                            <input type="checkbox" name="@rumorosita" id="@rumoroso" alt=@($"{utenti[i].Id}") value="rumoroso" @(Vote == 1 ? "checked='checked'" : "")>
                                            <label for="@rumoroso">Rumoroso</label>
                                        </div>
                                        <div class="vote_checkbox_item">
                                            <input type="checkbox" name="@rumorosita" id="@non_rumoroso" alt=@($"{utenti[i].Id}") value="non_rumoroso" @(Vote == -1 ? "checked='checked'" : "")>
                                            <label for="@non_rumoroso">Non rumoroso</label>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    }

                }
            }
        }
    </div>
    <div class="status_legend">
        <div class="status_head">
            <h1>Legenda</h1>
            <span class="divider"></span>
        </div>

        <div class="status_item">
            <div class="status_good"></div>
            <h2>Poco rumoroso</h2>
        </div>

        <div class="status_item">
            <div class="status_medium"></div>
            <h2>Medio</h2>
        </div>

        <div class="status_item">
            <div class="status_bad"></div>
            <h2>Rumoroso</h2>
        </div>
    </div>
</div>

<script src="js/vote.js"></script>

<script>
    // Abilita la deselezione
    $("input:checkbox").on('click', function () {
        var $box = $(this);
        if ($box.is(":checked")) {
            var group = "input:checkbox[name='" + $box.attr("name") + "']";
            $(group).prop("checked", false);
            $box.prop("checked", true);
        } else {
            $box.prop("checked", false);
        }
    });

    // Gestione voti
    $("input:checkbox").on('click', function () {
        var $box = $(this);
        var i = parseInt($box.attr("id").charAt($box.attr("id").length - 1)) - 1;
        let idUtenteVotato = parseInt($box.attr("alt"));

        if ($box.is(":checked")) {
            var group = "input:checkbox[name='" + $box.attr("name") + "']";
            $(group).prop("checked", false);
            $box.prop("checked", true);

            //se l'utente è stato votato come non rumoroso
            if ($box.attr("id").includes("non_rumoroso")) {
                $.ajax({
                    type: "POST",
                    url: "Votazioni/VoteUser",
                    data: { "Vote": -1, "idUtente": @LoggedUser.Id , "idUtenteVotato": $box.attr("alt") }
                });
                //se l'utente è stato votato come rumoroso
            } else {
                $.ajax({
                    type: "POST",
                    url: "Votazioni/VoteUser",
                    data: { "Vote": 1, "idUtente": @LoggedUser.Id , "idUtenteVotato": $box.attr("alt") }
                });
            }
            //se il Vote è stato tolto (neutrale)
        } else {
            $box.prop("checked", false);
            $.ajax({
                type: "POST",
                url: "Votazioni/VoteUser",
                data: { "Vote": 0, "idUtente": @LoggedUser.Id , "idUtenteVotato": $box.attr("alt") }
            }).done(function () {

            });
        }
    });

</script>