@{
    ViewData["Title"] = "Postazioni";

    PrenotazioneViewModel ViewModel = (PrenotazioneViewModel) Model;

}

@using System.Net
@using prenotazione_postazioni_libs.Models;
@using prenotazione_postazioni_libs.Dto;
@using prenotazione_postazioni_mvc.Controllers
@using prenotazione_postazioni_mvc.HttpServices;
@using Newtonsoft.Json;


    <div class="container mt-4 ml-3 position-fixed calendar-div">
        <div class="calendar">
            <div class="head">
                <ul class="d-flex align-items-center justify-content-center">
                    <li><img class="item item-img" src="img/left.png" alt="left" onclick="prevMonth()"></li>
                    <li><a class="item" id="month-year"></a></li>
                    <li><img class="item item-img" src="img/right.png" alt="right" onclick="nextMonth()"></li>
                </ul>
            </div>
            <div class="body">
                <table>
                    <tr>
                        <th>Lun</th>
                        <th>Mar</th>
                        <th>Mer</th>
                        <th>Gio</th>
                        <th>Ven</th>
                        <th>Sab</th>
                        <th>Dom</th>
                    </tr>
                    <tr>
                        <td id="0-0">1</td>
                        <td id="1-0">2</td>
                        <td id="2-0">3</td>
                        <td id="3-0">4</td>
                        <td id="4-0">5</td>
                        <td id="5-0">6</td>
                        <td id="6-0">7</td>
                    </tr>
                    <tr>
                        <td id="0-1">8</td>
                        <td id="1-1">9</td>
                        <td id="2-1">10</td>
                        <td id="3-1">11</td>
                        <td id="4-1">12</td>
                        <td id="5-1">13</td>
                        <td id="6-1">14</td>
                    </tr>
                    <tr>
                        <td id="0-2">15</td>
                        <td id="1-2">16</td>
                        <td id="2-2">17</td>
                        <td id="3-2">18</td>
                        <td id="4-2">19</td>
                        <td id="5-2">20</td>
                        <td id="6-2">21</td>
                    </tr>
                    <tr>
                        <td id="0-3">22</td>
                        <td id="1-3">23</td>
                        <td id="2-3">24</td>
                        <td id="3-3">25</td>
                        <td id="4-3">26</td>
                        <td id="5-3">27</td>
                        <td id="6-3">28</td>
                    </tr>
                    <tr>
                        <td id="0-4">29</td>
                        <td id="1-4">30</td>
                        <td id="2-4">31</td>
                        <td id="3-4">1</td>
                        <td id="4-4">2</td>
                        <td id="5-4">3</td>
                        <td id="6-4">4</td>
                    </tr>
                    <tr>
                        <td id="0-5">29</td>
                        <td id="1-5">30</td>
                        <td id="2-5">31</td>
                        <td id="3-5">1</td>
                        <td id="4-5">2</td>
                        <td id="5-5">3</td>
                        <td id="6-5">4</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="body">
            <table>
                <tr>
                    <th>Lun</th>
                    <th>Mar</th>
                    <th>Mer</th>
                    <th>Gio</th>
                    <th>Ven</th>
                    <th>Sab</th>
                    <th>Dom</th>
                </tr>
                <tr>
                    <td id="0-0">1</td>
                    <td id="1-0">2</td>
                    <td id="2-0">3</td>
                    <td id="3-0">4</td>
                    <td id="4-0">5</td>
                    <td id="5-0">6</td>
                    <td id="6-0">7</td>
                </tr>
                <tr>
                    <td id="0-1">8</td>
                    <td id="1-1">9</td>
                    <td id="2-1">10</td>
                    <td id="3-1">11</td>
                    <td id="4-1">12</td>
                    <td id="5-1">13</td>
                    <td id="6-1">14</td>
                </tr>
                <tr>
                    <td id="0-2">15</td>
                    <td id="1-2">16</td>
                    <td id="2-2">17</td>
                    <td id="3-2">18</td>
                    <td id="4-2">19</td>
                    <td id="5-2">20</td>
                    <td id="6-2">21</td>
                </tr>
                <tr>
                    <td id="0-3">22</td>
                    <td id="1-3">23</td>
                    <td id="2-3">24</td>
                    <td id="3-3">25</td>
                    <td id="4-3">26</td>
                    <td id="5-3">27</td>
                    <td id="6-3">28</td>
                </tr>
                <tr>
                    <td id="0-4">29</td>
                    <td id="1-4">30</td>
                    <td id="2-4">31</td>
                    <td id="3-4">1</td>
                    <td id="4-4">2</td>
                    <td id="5-4">3</td>
                    <td id="6-4">4</td>
                </tr>
                <tr>
                    <td id="0-5">29</td>
                    <td id="1-5">30</td>
                    <td id="2-5">31</td>
                    <td id="3-5">1</td>
                    <td id="4-5">2</td>
                    <td id="5-5">3</td>
                    <td id="6-5">4</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<!-- Piantina Div -->
<div class="container mt-4 ml-21 position-fixed piantina-div">
        <img src="img/piantina.png" usemap="#image-map">

        <map name="image-map" id="image-map">
            <area alt="Contabilità" title="Contabilità" coords="44,47,140,45,143,132,38,148" shape="poly">
            <!--<area alt="s2" title="s2" coords="148,155,182,161,182,122,310,119,312,39,148,40" shape="poly">
            <area alt="s3" title="s3" coords="185,161,185,127,300,126,300,175" shape="poly">
            <area alt="s4" title="s4" coords="306,126,344,128,344,182,306,177" shape="poly">
            <area alt="s5" title="s5" coords="316,117,342,117,344,101,388,98,389,39,318,42,317,62" shape="poly">
            <area alt="s6" title="s6" coords="349,183,390,189,391,111,350,110" shape="poly">.-->
            <!--<area alt="Finanze" title="Finanze" coords="400,40,484,41,484,107,401,110" shape="poly">-->
            <area alt="Bansky" title="Bansky" coords="398,118,488,119,486,204,398,193" shape="poly">
            <area alt="OpenSpace #1" title="OpenSpace #1" coords="491,40,706,64,708,145,492,123" shape="poly">
            <area alt="OpenSpace #2" title="OpenSpace #2" coords="492,207,704,231,704,147,492,126" shape="poly">
            <!--<area alt="s10" title="s10" coords="544,225,598,232,595,265,540,261" shape="poly">
            <area alt="s11" title="s11" coords="606,233,660,242,655,275,600,266" shape="poly">
            <area alt="s12" title="s12" coords="588,310,705,330,708,495,588,495" shape="poly">-->
            <area alt="Sviluppo" title="Sviluppo" coords="480,292,578,311,577,501,478,506" shape="poly">
            <area alt="Assistenza" title="Assistenza" coords="357,494,456,498,450,291,371,293,360,327" shape="poly">
            <!--<area alt="s15" title="s15" coords="43,246,134,260,135,376,122,383,46,384" shape="poly">
            <area alt="s16" title="s16" coords="43,399,125,397,147,415,149,508,52,509" shape="poly">
            <area alt="s17" title="s17" coords="161,508,247,508,248,403,178,403,160,417" shape="poly">-->
            <area alt="Commerciale" title="Commerciale" coords="262,405,301,385,344,382,347,506,259,507" shape="poly">
            <area alt="Meeting" title="Meeting" coords="207,251,230,236,259,225,278,223,301,228,318,241,328,267,324,291,316,308,301,327,285,340,262,351,236,359,198,352,186,339,180,324,180,306,186,281" shape="poly">
        </map>
    </div>

<!-- Room info Div -->
<div class="container mt-4 ml-70 position-fixed room-info-div">
    <h1>@ViewModel.GetStanza()</h1>
    <br>
    <div class="btn-collapse">
        <a data-toggle="collapse" id="orario-btn" href="#orario" role="button" aria-expanded="false" aria-controls="collapseExample">
            Seleziona orario
        </a>
    </div>
    <div>
        <div class="collapse" id="orario">
            <div class="card card-body">
                <label for="start">Inizio</label>
                <input type="time" id="start" name="start" step="3600000" value="@ViewModel.FormatHour(@ViewModel.Start.Hour):00"
                       min="07:00" max="22:00" required>
                <label for="finish">Termine</label>
                <input type="time" id="finish" name="finish" step="3600000" value="@ViewModel.FormatHour(@ViewModel.End.Hour):00"
                       min="07:00" max="22:00" required>
            </div>
        </div>
    </div>
    <br>
    <div class="btn-collapse">
        <a data-toggle="collapse" id="prenotazioni-btn" href="#prenotazioni" role="button" aria-expanded="false" aria-controls="collapseExample">
            Persone prenotate
        </a>
    </div>
    <div>
        <div class="collapse" id="prenotazioni">
            <div class="card card-body person-div">
                <ul>
                    @{
                        List<Utente> utenti = ViewModel.Presenti;
                        if(utenti != null || utenti.Count != 0)
                        {
                            foreach (var utente in utenti)
                            {
                                <li> <img src="~/img/example/example-2.png">utente.Nome utente.Cognome</li>
                            }
                        }
                        else
                        {
                            <li>Nessuna prenotazione trovata!</li>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>
    <br>
    <div>
        <button class="btn btn-primary bg-darkorange bd-darkorange" type="button" id="prenota">Prenota</button>
    </div>

</div>

<div class="alert-box">
    <div class="alert-box-view" style="opacity: 0" id="error-box">
        <!-- Qui dentro viene inserito il codice di errore -->
    </div>
</div>

<script>

    let usingAlertBox = false;

    function alertBox(message) {
        let alertBox = $('#error-box');

        alertBox.text(message);

        if (usingAlertBox === false) {
            usingAlertBox = true;
            alertBox.animate({ opacity: 0 }, 0);
            alertBox.animate({ opacity: 1 },
                750,
                "swing",
                function() {
                    setTimeout(function() {
                            alertBox.animate({ opacity: 0 },
                                750,
                                "swing",
                                function() {
                                    usingAlertBox = false;
                                    alertBox.text("");
                                });
                        },
                        3000);
                });
        } 

    }

</script>

<script>

    $(document).ready(function() {

        // Id dei collapse #orario
        let orarioBtn = $('#orario-btn');
        let orarioDiv = $('#orario');

        // Id dei collapse #prenotazioni 
        let prenotazioniBtn = $('#prenotazioni-btn');
        let prenotazioniDiv = $('#prenotazioni');

        // Stato dei collapse
        let stateCollapseHour = @ViewModel.CollapsedHour;
        let stateCollapseList = @ViewModel.CollapsedList;

        // Se lo stato salvato === 1, allora visulaizza il collapse aperto, altrimenti tieni chiuso
        if (stateCollapseHour === 1) {
            orarioBtn.removeClass('collapsed');
            orarioDiv.addClass('show');
        }

        if (stateCollapseList === 1) {
            prenotazioniBtn.removeClass('collapsed');
            prenotazioniDiv.addClass('show');
        }

        // Fix spam click
        let clickedOrarioBtn = false;
        let clickedPrenotazioniBtn = false;

        /*
         * Salva lo stato dei collapse: Ogni volta che viene ricaricata la pagina, quindi
         * ogni volta che viene aggiornato un dato, mantiene attivo lo stato dei collapse senza resettarli.
         *
         * Senza questa funzione i collapse si chiuderanno sempre.
         */

        // Collapse #orario

        orarioBtn.on('click', function(event) {
                if (clickedOrarioBtn === false) {
                    clickedOrarioBtn = true;
                    $.ajax({
                        type: "POST",
                        url: "Home/CollapseHour"
                    }).done(function() {
                        clickedOrarioBtn = false;
                    });
                }
            }
        );

        // Collapse  #prenotazioni

        prenotazioniBtn.on('click', function(event) {
                if (clickedPrenotazioniBtn === false) {
                    clickedPrenotazioniBtn = true;
                    $.ajax({
                        type: "POST",
                        url: "Home/CollapseList"
                    }).done(function() {
                        clickedPrenotazioniBtn = false;
                    });
                }
            }
        );

        prenota.on('click', function(event) {
            $.ajax({
                type: "POST",
                url: "Home/MakePrenotazione",
                data: { "idUtente": 1, "startYear": @ViewModel.Date.Year, "startMonth": @ViewModel.Date.Month, "startDay": @ViewModel.Date.Day, "endYear": @ViewModel. }
            }).done(function() {
                window.location.reload();
            })
        })
    });
</script>
<script>
    
    // Giorno selezionato nel calendario
    let daySel = new Date(@ViewModel.Date.Year, (@ViewModel.Date.Month - 1), @ViewModel.Date.Day);

    // Porta il calendario al giorno selezionato
    goDate(daySel);
    
    // Controlla se nel mese corrente è presente un giorno selezionato
    if ((month === 11 ? 0 : (month+1)) === daySel.getMonth())
        clickCalendar(getIdDay(@ViewModel.Date.Day));

    /*
    * ! <area> è utilizzato unicamente nella Map.
    * Raccoglie il click dalla mappa delle stanze, cambia il valore nel ViewModel e ricarica la pagina.
    */

    $('area').on('click', function () {
        let nameStanza = event.target.alt;

        $.ajax({
            type: "POST",
            url: "Home/ReloadRoom",
            data: { "room": nameStanza }
        }).done(function() {
            window.location.reload();
        });
    });

    /*
     * ! <td> è utilizzato unicamente nei Calendar.
     * Raccoglie il click da un calendar, comprende il tipo di calendar in base alla quantità
     * di caratteri dell'id del <td> sulla quale è stato chiamato l'evento.
     */

    $('td').on('click', function(event) {
        if (isValidDay(event.target.id))
            $.ajax({
                type: "POST",
                url: "Home/ReloadDay",
                data: { "year": date.getFullYear(), "month": date.getMonth(), "day": $('#'.concat(event.target.id)).text() },
                error: function(xhr) {
                    alertBox(xhr.responseText);
                    event.preventDefault();
                }
            }).done(function(data) {
                window.location.reload();
            });
    });

    /**
     * Seleziona un nuovo orario di Inizio, controlla se valido e infine ricarica la pagina con la lista
     * presenze aggiornata.
     */

    $('#start').on('change', function(event) {
        $.ajax({
            type: "POST",
            url: "Home/ReloadStart",
            data: { "hour": (event.target.value).split(":")[0] },
            error: function(xhr) {
                alertBox(xhr.responseText);
                event.preventDefault();
                event.target.value = "@ViewModel.FormatHour(@ViewModel.Start.Hour):00";
            }
        }).done(function() {
            window.location.reload();
        });
    });

    /**
     * Seleziona un nuovo orario di Termine, controlla se valido e infine ricarica la pagina con la lista
     * presenze aggiornata.
     */

    $('#finish').on('change', function(event) {

        $.ajax({
            type: "POST",
            url: "Home/ReloadFinish",
            data: { "hour": (event.target.value).split(":")[0] },
            error: function(xhr) {
                alertBox(xhr.responseText);
                event.preventDefault();
                event.target.value = "@ViewModel.FormatHour(@ViewModel.End.Hour):00";
            }
        }).done(function() {
            window.location.reload();
        });
    });

</script>